rsqlserver documentation
========================================================
The rsqlserver package is an implementation of the R DBI package to access SQL server data base, that
uses the.NET Framework Data Provider for high preformance and scalability with SQL Server data base.
In fact , using thee [Rclr package](https://rclr.codeplex.com/), rsqlserver access to System.Data.SqlClient namespace.

It requires:

* R 3.0 or above. May work with earlier version
* .NET 4.0
* MS Visual C++ 2012 runtime


It presentes:

* Connection to Sql server
* Querying the data base : low levels functions using sql statement.
* Higher level convenient functions that support read, save, copy, and manipulation of data between R data.frame objects and database tables.
* Transaction management to commit and rollback
* Stored procedure call ( not yet implemented)
* Uses named parameters in the format @parametername to pass values to SQL statements or stored procedures. 
This will provide better type checking and imporve performance. (not yet implemented)



```{r initpackage,warning=FALSE,message=FALSE}
library(rsqlserver)
```
## Typical scenario

A typical use of the rsqlserver package is :

* Open a connection 
* Execute a query 
* Extract the query result in a data.frame
* Close the query result
* Close the connection


```{r  typicalUse}
drv <- dbDriver('SqlServer')
conn <- dbConnect(drv,user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
query <- "SELECT  name,object_id,create_date 
          FROM    sys.tables"
res <- dbSendQuery(conn, query)
res.dat <- fetch(res)
invisible(dbClearResult(res))
invisible(dbDisconnect(conn))
head(res.dat)

```

In practice , we don't fetch results manullay and we use the handy function `dbGetQuery`
To simplify the previous example to : 


```{r  getquery}
query <- "SELECT  name,object_id,create_date 
          FROM    sys.tables"
conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
res <- dbGetQuery(conn, query)
invisible(dbDisconnect(conn))
head(res)

```

## Connections
To create a connection, you should call dbConnect. Here some example:

```{r connections}
drv <- dbDriver('SqlServer')
conn <- dbConnect(drv,user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
dbDisconnect(conn)
conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
dbDisconnect(conn)

```

to retrieve information about the connection , you can do this :
```{r geConnectionInfo}
drv <- dbDriver('SqlServer')

conn <- dbConnect(drv,user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
dbGetInfo(conn)
dbGetInfo(conn,"State")
dbDisconnect(conn)
dbGetInfo(conn,"State")
```


## SQL Results

Use dbGetInfo to retrieve the result state. 

```{r getResultsInfo}
drv <- dbDriver('SqlServer')
conn <- dbConnect(drv,user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
res <- dbSendQuery(conn, "select * from sys.tables")
dbGetInfo(res,'HasRows')
dbHasCompleted(res)
dbClearResult(res)
dbHasCompleted(res)
dbDisconnect(conn)


```

then you can fetch the result.


```{r fetchResult}

drv <- dbDriver('SqlServer')
conn <- dbConnect(drv,user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
res <- dbSendQuery(conn, "select * from sys.tables")
if(!dbHasCompleted(res))
  res.dat <- fetch(res,4) ## retrieve only 4 rows

dbClearResult(res)
dbDisconnect(conn)

```


## Convenience functions for Importing/Exporting DBMS tables

These functions mimic their R/Splus counterpart get, assign, exists, remove, and objects, except that they generate code that gets remotely executed in a database engine.

*  `dbReadTable(conn, name, ...)`
*  `dbWriteTable(conn, name, value, ...)`
*  `dbExistsTable(conn, name, ...)`
*  `dbRemoveTable(conn, name, ...)`

To check if a table already exist:

```{r dbTableExist}

conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
res <- dbExistsTable(conn, "BM_INDICE")
dbDisconnect(conn)

```


to read a sql server table as a data.frame

```{r dbReadTableL}
conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)

rs <- dbSendQuery(conn,'SELECT * FROM BM_INDICE')
dat.rs <- fetch(rs,n=-1)
dbClearResult(rs)
dbDisconnect(conn)

```
Or sipmly use the convenient function dbReadTable

```{r dbReadTable}
conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
res <- dbReadTable(conn, "BM_INDICE")

dbDisconnect(conn)

```


you have 2 methods to create a new table 


```{r createNewTable1}
conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
if(!dbExistsTable(conn,'MYTABLE')){
  rs <- dbSendQuery(conn,"CREATE TABLE MYTABLE ( myvar varchar(1) )")
  dbClearResult(rs)
  }
dbReadTable(conn, 'MYTABLE')
dbDisconnect(conn)

```

Since the creation of a table does not retuen a result, it is better to 
use dbGetScalar.
```{r createNewTable2}
conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
if(!dbExistsTable(conn,'MYTABLE1'))
  dbGetScalar(conn,"CREATE TABLE MYTABLE1 ( myvar varchar(1) )")
dbReadTable(conn,'MYTABLE1')
dbDisconnect(conn)

```

To remove a table :
```{r dbremoveTable}

conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
if(dbExistsTable(conn, "MYTABLE2"))
   dbRemoveTable(conn,"MYTABLE2")
dbDisconnect(conn)

```

To create a new table :

```{r dbWriteTable}
conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)

if(dbExistsTable(conn, "MYTABLE2"))
  dbWriteTable(conn,'T_MTCARS',mtcars)
dbDisconnect(conn)


```

## Transactions

```{r transaction}
conn <- dbConnect('SqlServer',user="collateral",password="collat",
                 host="localhost",trusted=TRUE, timeout=30)
conn <- dbTransaction(conn,name='newTableTranst')
tryCatch(
     {
       dbGetScalar(conn,"CREATE TABLE MYTABLE3 
                        ( myvar varchar(1) )")
       dbGetScalar(conn,"CREATE TABLE MYTABLE2 
                         ( myvar varchar(1) )")
       dbCommit(conn)
      },
  error=function(e){
    dbRollback(conn)
    },
  finally=dbDisconnect(conn)
  )


```









