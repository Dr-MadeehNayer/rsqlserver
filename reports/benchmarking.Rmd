```{r bench.settings,echo=FALSE}
opts_chunk$set(warning=FALSE)
opts_chunk$set(message=FALSE)
TABLE_NAME = "T_BENCHMARKING2"

```


R and MS Sql server Connectivity: Use rslqserver for  Performance ,Scalability and DBI compliant
=============================================================

## Introduction

R users have a few choices of how to connect to their MS Sql Server Database. The most commonly seen include:

* RODBC to access from Windows environment 
* RJDBC to access from Linux like environment

However, these packages have significantly different performance and scalability characteristics which can greatly impact your application development. 

In this report, we will we will discuss these options and highlight performance benchmark results on a wide range of data sets.


## Configuration

To compare these interfaces, we prepared tests along several dimensions:

* Number of rows 1M
* Number of columns 100
* Data types â€“ numeric., randomly generated
* Interfaces: RODBC 1.3-0 ,  rsqlserver 1.0 
* Types of operations: select *, create table, connect
* Data base :Microsoft SQL Server 2008 Express Edition (64-bit)


## Connections 

A Typical way to connect to Sql Server from `RODBC` is to define a Data Source Name or DSN 

```{r conn.rodbc}
library(RODBC)
conn.rodbc <- function(){
  odbcConnect(dsn = "my-dns", uid = "collateral", pwd = "collat")
  }
````
In the other side `rsqlserver` offer many ways to acces to the data base. You can either sppecify an url for connection string or specify some parameters like server address, data base name , user name and paswword,...
One inetrsting option is to use the Integrated Security and Trusted_Connection to specify wheter the connnection is secure, such as Windows Authentication or SSPI.

Windows Authentication is sometimes called a trusted connection, because SQL Server trusts the credentials provided by Windows.

```{r conn.rsqlserver}
library(rsqlserver)
conn.rsqlserver <- function(){
  url = "Server=localhost;Database=TEST_RSQLSERVER;Trusted_Connection=True;"
  conn <- dbConnect('SqlServer',url=url)
  }

```

Depending on the application any sub-second response time may be sufficient. But `rsqlserver` is much faster than RODBC.

```{r bench.connections}

library(microbenchmark)
microbenchmark(conn1<- conn.rodbc(),conn2 <- conn.rsqlserver(),times=1)
````



### Creating data


We will create 1Mx100 matrix using `dbBulkCopy`. This is a new feature that rsqlserver offer gracefuly.
`dbBulkCopy` is differ from  `dbWriteTable` :
* it is much faster 
* Not limited in number of rows : `dbWriteTable` can write at most 1000 rows.  
* can load a file or data.frame. Internally, the data.farme is saved as a file.

Here I am creating 1Mx100 tables.

```{r gen.bigtable, eval=FALSE }

N = 100000
ncol=100

url = "Server=localhost;Database=TEST_RSQLSERVER;Trusted_Connection=True;"
conn <- dbConnect('SqlServer',url=url) 
cnames <- paste0('col',seq_len(ncol))
rsqlserver:::dbCreateTable(conn,TABLE_NAME, 
  												 cnames,rep("float",ncol))
gen.matrix <- function() {
	replicate(10,{
		dat <- matrix(round(rnorm(N*ncol),2),
									nrow=N,
									ncol=ncol)
		colnames(dat) <- cnames 
		id.file = "d:/temp/temp.csv"                      
		write.csv(dat,file=id.file,row.names=FALSE)
		dbBulkCopy(conn,name=TABLE_NAME,value=id.file)
		rm(dat)
	})
}

system.time(gen.matrix())

dbDisconnect(conn)


```


## Loading database data to an R data.frame

Here we present 2  methods to get the results:

* Using sqlQuery from RODBC package 
* Using dbGetQuery from rsqlserver package since it a DBI interafce.


```{r query}

nrows <- 100000

qselect <- paste0("SELECT TOP ", format(nrows, scientific=F), " * 
                FROM ",TABLE_NAME)
## RODBC
get.rodbc <- function (conn,query=qselect){
  res <- sqlQuery(conn, query)
  res
  }
## rsqlserver dbGetQuery
get.rsqlserver <- function(conn,query=qselect){
  res <- dbGetQuery(conn,statement= query)
  res
  }


```

Comapring results:

```{r bench.query}
conn1 <- conn.rodbc()
conn2 <- conn.rsqlserver()
microbenchmark(get.rodbc(conn1),
               get.rsqlserver(conn2),
               times=1)

dbDisconnect(conn2)

```
