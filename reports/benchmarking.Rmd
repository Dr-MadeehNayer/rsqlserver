```{r bench.settings,echo=FALSE,message=FALSE,warning=FALSE}
opts_chunk$set(warning=FALSE)
opts_chunk$set(message=FALSE)
library(ggplot2)
src.path <- ifelse(!file.exists("benchmarking.R"),
                   'reports','.')
source(paste(src.path,'benchmarking.R',sep='/'))

```

R and MS SQl server: Use rslqserver for  Performance ,Scalability
=============================================================

## Introduction

R users have a few choices of how to connect to their MS Sql Server Database. The most commonly seen include:

* `RODBC` to access essentially  Windows environment 
* `RJDBC` to access from Linux/windows like environment
* `rsqlserver` the new package working on windows. An extension to linux based [Mono SqlClient](http://www.mono-project.com/SQLClientMono project) should be feasible. (Any help is welcome)

However, these packages have significantly different performance and scalability characteristics which can greatly impact your application development. 

In this report, we will we will discuss these options and highlight performance benchmark results on a wide range of data sets.


## Configuration

To compare these interfaces, we prepared tests along several dimensions:

* Number of rows : `r  paste0(bench.rows,'K',collapse=', ')`
* Number of columns : `r paste0(bench.cols,collapse=', ')`
* Data types â€“ NUMBER, DATETIME2, and VARCHAR; Numeric data is randomly generated, all character data is 10 characters long.
* Interfaces: RODBC 1.3-0 ,  rsqlserver 1.0 ,RJDBC 0.2-1, R 3.0.2
* Types of operations: select *, create table, connect
* Data base :Microsoft SQL Server 2008 Express Edition (64-bit)


## Connections 

A Typical way to connect to Sql Server from `RODBC` is to define a Data Source Name or DSN 

```{r conn.rodbc}
conn.rodbc <- function(){
  odbcConnect(dsn = "my-dns", uid = "collateral", pwd = "collat")
  }
````
In the other side `rsqlserver` offer many ways to acces to the data base. 

You can either specify an url for [connection string](http://www.connectionstrings.com/sql-server-2005/) or specify some parameters like:

* server address
* data base name 
* user name and paswword

One inetrsting option is to use the Integrated Security and Trusted_Connection arguments. to specify wheter the connnection is secure, such as Windows Authentication or SSPI. Windows Authentication is sometimes called a trusted connection, because SQL Server trusts the credentials provided by Windows.

So my connection function looks like this:

```{r conn.rsqlserver}
conn.rsqlserver <- function(){
  url = "Server=localhost;Database=TEST_RSQLSERVER;Trusted_Connection=True;"
 #url = "Server=localhost;Database=TEST_RSQLSERVER;user id=collateral;password=collat;"
  conn <- dbConnect('SqlServer',url=url)
  }

```

Depending on the application any sub-second response time may be sufficient. But there are many applications where we need a fast data base connection.

```{r conn.rjdbc}
conn.rjdbc <- function(){
drv = JDBC('com.microsoft.sqlserver.jdbc.SQLServerDriver',
           'd:/temp/sqljdbc_4.0/enu/sqljdbc4.jar')
url = 'jdbc:sqlserver://localhost;user=collateral;password=collat;databasename=TEST_RSQLSERVER;'
conn <- dbConnect(drv,url=url )
 }

```


```{r bench.connections}

tm <- microbenchmark( conn3 <- conn.rjdbc(), 
                      conn1<- conn.rodbc(),
                     conn2 <- conn.rsqlserver(),
                     times=1)
dat <- sapply(LIST_DRIVERS,function(driver)
  microbenchmark:::convert_to_unit(tm[grep(driver,tm$expr),]$time,'s'))
ggplot(stack(dat))+
  geom_bar(aes(x=ind,y=values,fill=ind),stat='identity') +
  xlab('driver') + ylab('time(s)') +
  ggtitle('Database connection times RODBC and rsqlserver')
````

`rsqlserver` is **96 times faster** than `RODBC` ** to connect to the data base. 


### Creating data with dbBulkCopy

`dbBulkCopy` DBI extension interfaces the Microsoft SQL Server includes a popular command-line utility named [bcp](http://msdn.microsoft.com/en-us/library/7ek5da1a(v=vs.110).aspx)  quickly bulk copying large files into table.

`dbBulkCopy` extends `dbWriteTable` and offer best perofomance an scalability :

* Not limited in number of rows : `dbWriteTable` can write at most 1000 rows.  
* You can load data from a file or a data.frame. Internally, the data.farme is always saved as a file.

For example a typical use:

* Here I am creating a matrix nrow*ncol
* I save it in a file
* I call dbBulkCopy for quickly bulk copy.

```{r gen.bigtable, eval=FALSE }
dat <- matrix(round(rnorm(nrow*ncol),2),
              nrow=nrow,
              ncol=ncol)
colnames(dat) <- cnames 
id.file = "temp_file.csv"                      
write.csv(dat,file=id.file,row.names=FALSE)
dbBulkCopy(conn,'NEW_BP_TABLE',value=id.file)

```


## Loading database data to an     R data.frame

Typical usage of data base packages is to pull data to the R  for subsequent processing. 
Typical query calls:
* `sqlQuery` for RODBC package 
*  `dbGetQuery` for rsqlserver/RJDBC packages since are DBI interafce implementation


Below the benchmarking code:

```{r bencher.table,fig.align='center',fig.cap='benchamrking',fig.width=8,eval=TRUE}

res <- engine(  csize < 50 ,bencher.table)
ggplot(res) +
  geom_point(aes(x=rsize,y=time,color=method,shape=method),size=4) +
  facet_grid(type~csize,scales = "free_y") +
   scale_x_log10() +
  ylab(label='time(s)') +
  ggtitle("rsqlserver versus other drivers for \n small tables extraction") 

```

SInce RODBC fails to extract all rows for bigg table ( 750 columns with 10^5 rows) 
We do many select x `r paste(seq(1,100,10),collapse=', ')`Here for the big table 
```{r bencher.points}
res.big <- engine( rsize ==1000 & csize ==10 ,bencher.points)

ggplot(res.big) +
  geom_line(aes(x=rsize,y=time,color=method)) +
  geom_point(aes(x=rsize,y=time,color=method),size=4) +
  facet_grid(~name) +
  ylab(label='time(s)') +
  ggtitle("rsqlserver versus other drivers for \n big tables extraction") 
```


Note that `rsqlserver` and `ROODBC` both scale to these volumes, But  `rsqlserver` is consistently faster than `ROODBC`  up to 1000 faster.
