```{r bench.settings,echo=FALSE}
opts_chunk$set(warning=FALSE)
opts_chunk$set(message=FALSE)
TABLE_NAME = "T_BENCH_"

bench.cols <- c(10,50,100,750)
bench.rows <- c(1,10,100)
bench.types = c('NUM','CHAR','DATE')
  

```


R and MS Sql server Connectivity: Use rslqserver for  Performance ,Scalability and DBI compliant
=============================================================

## Introduction

R users have a few choices of how to connect to their MS Sql Server Database. The most commonly seen include:

* RODBC to access from Windows environment 
* RJDBC to access from Linux like environment

However, these packages have significantly different performance and scalability characteristics which can greatly impact your application development. 

In this report, we will we will discuss these options and highlight performance benchmark results on a wide range of data sets.


## Configuration

To compare these interfaces, we prepared tests along several dimensions:

* Number of rows : `r  paste0(c(1,2),'K',collapse=', ')`
* Number of columns : `r paste0(bench.cols,collapse=', ')`
* Data types â€“ NUMBER, DATETIME2, and VARCHAR; Numeric data is randomly generated, all character data is 10 characters long.
* Interfaces: RODBC 1.3-0 ,  rsqlserver 1.0 , R 3.0.2
* Types of operations: select *, create table, connect
* Data base :Microsoft SQL Server 2008 Express Edition (64-bit)


## Connections 

A Typical way to connect to Sql Server from `RODBC` is to define a Data Source Name or DSN 

```{r conn.rodbc}
library(RODBC)
conn.rodbc <- function(){
  odbcConnect(dsn = "my-dns", uid = "collateral", pwd = "collat")
  }
````
In the other side `rsqlserver` offer many ways to acces to the data base. You can either sppecify an url for connection string or specify some parameters like server address, data base name , user name and paswword,...
One inetrsting option is to use the Integrated Security and Trusted_Connection to specify wheter the connnection is secure, such as Windows Authentication or SSPI.

Windows Authentication is sometimes called a trusted connection, because SQL Server trusts the credentials provided by Windows.

```{r conn.rsqlserver}
library(rsqlserver)
conn.rsqlserver <- function(){
  url = "Server=localhost;Database=TEST_RSQLSERVER;Trusted_Connection=True;"
  conn <- dbConnect('SqlServer',url=url)
  }

```

Depending on the application any sub-second response time may be sufficient. 
But **`rsqlserver` is much faster than `RODBC` ** to connect to the data base. 

```{r bench.connections}
library(microbenchmark)
tm <- microbenchmark(conn1<- conn.rodbc(),conn2 <- conn.rsqlserver(),
               times=1)

library(ggplot2)
autoplot(tm)
````



### Creating data with dbBulkCopy

`dbBulkCopy` DBI extension interfaces the Microsoft SQL Server includes a popular command-line utility named [bcp](http://msdn.microsoft.com/en-us/library/7ek5da1a(v=vs.110).aspx)  quickly bulk copying large files into table.

`dbBulkCopy` extends `dbWriteTable` and offer best perofomance an scalability :

* Not limited in number of rows : `dbWriteTable` can write at most 1000 rows.  
* You can load data from a file or a data.frame. Internally, the data.farme is always saved as a file.

For example a typical use:

* Here I am creating a matrix nrow*ncol
* I save it in a file
* I call dbBulkCopy for quickly bulk copy.

```{r gen.bigtable, eval=FALSE }
  dat <- matrix(round(rnorm(nrow*ncol),2),
                  nrow=nrow,
                  ncol=ncol)
  colnames(dat) <- cnames 
  id.file = "temp_file.csv"                      
  write.csv(dat,file=id.file,row.names=FALSE)
  dbBulkCopy(conn,'NEW_BP_TABLE',value=id.file)

```


## Loading database data to an R data.frame

Typical usage of data base packages is to pull data to the R  for subsequent processing. 
Typical query are done :
* Using `sqlQuery` from RODBC package 
* Using `dbGetQuery` from rsqlserver package since it a DBI interafce.



Below the benchmarking code:

```{r bench.query,fig.align='center',fig.cap='benchamrking',fig.width=8}
options(stringsAsFactors=FALSE)
tt <- dbListTables(conn2)
tables.names <- rep('T_BENCH_.*',tt,value=TRUE)
bench.props = data.frame(
  name   = tables.names,
  rsize  = as.integer(gsub('.*BENCH_(.*)_(.*)_(.*)','\\3',tables.names)),
  csize  = as.integer(gsub('.*BENCH_(.*)_(.*)_(.*)','\\2',tables.names)),
  type   = gsub('.*BENCH_(.*)_(.*)_(.*)','\\1',tables.names))


ll <- lapply(bench.props$name[1:18], function(TABLE_NAME){
  qselect <- paste0("SELECT * FROM ",TABLE_NAME)
  res <- microbenchmark(sqlQuery(conn1, qselect),
                        dbGetQuery(conn2,qselect),
                        times=1)
     time = microbenchmark:::convert_to_unit(res$time,'s')
     method = as.character(res$expr)
     method <- gsub('dbGet.*','rsqlserver',method)
     method <- gsub('sqlQ.*','rodbc',method)
     setNames(time,method)
     data.frame(name=TABLE_NAME,time=time,method=method)
       
  })

res <- do.call(rbind,ll)
res <- merge(bench.props ,res)

dbDisconnect(conn2)
ggplot(res) +
  geom_line(aes(x=rsize,y=time,color=method)) +
  geom_point(aes(x=rsize,y=time,color=method),size=4) +
  facet_grid(type~csize) +
  scale_x_log10(breaks=bench.rows*1000, 
                       labels=paste0(bench.rows,'K')) +
  ylab(label='time(s)') +
  ggtitle("RODBC versus rsqlserver for \n different data types and table sizes") 

```


In This test , we compare the execution time to pull Top `r paste0(times,'K')` rows of  100 columns of data from 1M rows of float type data table.

Note that `rsqlserver` and `ROODBC` both scale to these volumes, But  `rsqlserver` is consistently faster than `ROODBC`  up to 1000 faster.
